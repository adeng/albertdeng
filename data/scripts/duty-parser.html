<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script>
            var output = "";

            $(document).ready( function() {
                var total = 0;
                var processing = 0;
                $("#drag").on({
                    'dragover dragenter': function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    },
                    'drop': function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var files = e.originalEvent.dataTransfer.files;
                        total = files.length;
                        $("#progress").val(total + " files uploaded. 0 completed");
                        
                        for(var i = 0; i < files.length; i++) {
                            var f = new FileReader();
                            f.readAsText(files[i]);

                            f.onload = function() {
                                getFile(f.result);
                                processing++;
                                $("#progress").val(total + " files uploaded. " + processing + " completed");
                            }
                        }
                        return false;
                    }
                });
            });

            function getFile(data) {
                var $parsed = $($.parseXML(data));
                console.log($.parseXML(data));

                var jobRole = $parsed.find("NAME")[0].innerHTML;
                var jobDesc = $parsed.find("ASSIGNED-ROLE-DESCRIPTION")[0].innerHTML;

                var dutyRoles = [];
                for(var i = 0; i < $parsed.find("APPLICATION").length; i++) {
                    var app = $parsed.find("APPLICATION")[i];

                    var entitlements = $(app).find("ENTITLEMENT");
                    var uniqueEnts = [];
                    for(var j = 0; j < entitlements.length; j++) {
                        uniqueEnts.push([entitlements[j].childNodes[3].innerHTML.trim(), entitlements[j].childNodes[5].innerHTML.trim()]);
                    }

                    if(uniqueEnts[0] != "") {
                        uniqueEnts.sort(function(a, b) {
                            return a[0].localeCompare(b[0]);
                        });
                    } else {
                        uniqueEnts[0] = "None";
                    }
                    
                    // console.log(app.childNodes[1]);
                    dutyRoles.push([app.childNodes[3].childNodes[5].innerHTML.trim(), app.childNodes[3].childNodes[7].innerHTML.trim(), app.childNodes[1].innerHTML.trim().toUpperCase(), uniqueEnts]);
                }

                dutyRoles.sort(function(a, b) {
                    return a[0].localeCompare(b[0]);
                });

                var uniqueRoles = [];
                uniqueRoles.push(dutyRoles[0]);

                for(var j = 1; j < dutyRoles.length; j++) {
                    if(uniqueRoles[uniqueRoles.length - 1][0] != dutyRoles[j][0]) {
                        uniqueRoles.push(dutyRoles[j]);
                    }
                }
                
                constructCSV(jobRole, jobDesc, uniqueRoles);
            }

            function constructCSV(jobRole, jobDesc, dutyRoles) {
                var o = "";
                for(var j = 0; j < dutyRoles.length; j++) {
                    for(var k = 0; k < dutyRoles[j][3].length; k++) {
                        o += '"' + jobRole + '","' + jobDesc + '","' + dutyRoles[j][0] + '","' + dutyRoles[j][1] + '","' + dutyRoles[j][3][k][0] + '","' + dutyRoles[j][3][k][1] + '",\n';
                    }
                }

                output += o;
            }

            function download(filename, text) {
                var pom = document.createElement('a');
                pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                pom.setAttribute('download', filename);

                if (document.createEvent) {
                    var event = document.createEvent('MouseEvents');
                    event.initEvent('click', true, true);
                    pom.dispatchEvent(event);
                }
                else {
                    pom.click();
                }
            }
        </script>
        <style>
            .drag {
                border: 2px solid black;
                width: 90vw;
                margin: 5%;
            }
        </style>
    </head>
    <body>
        <h2>Oracle User and Role Access Audit Report Processor</h2>
        <div class="drag" id="drag">
            <h1 style="text-align: center">Drag file here to upload</h1>
        </div>
        <input type="text" id="progress" disabled />
        <!--<textarea id="input" rows="10" cols="80">
        </textarea>-->
        <!--<label for="inputfile">Name of file: </label><input id="inputfile" type="text" />
        <br />-->
        <button id="execute" onclick="download('output.csv', output)">Submit</button>
        <!-- 
        <h2>Output</h2>
        <textarea id="output" rows="10" cols="80">
        </textarea>-->
    </body>
</html>