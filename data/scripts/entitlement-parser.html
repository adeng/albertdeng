<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script>
            $(document).ready( function() {
                $("#drag").on({
                    'dragover dragenter': function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    },
                    'drop': function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var file = e.originalEvent.dataTransfer.files[0];
                        var f = new FileReader();
                        f.readAsText(file);

                        f.onload = function() {
                            getFile(f.result);
                        }
                        return false;
                    }
                });
            });

            function getFile(data) {
                var $parsed = $($.parseXML(data));

                var jobRole = $parsed.find("ROLE-ID")[0].innerHTML;

                var entitlements = $parsed.find("ENTITLEMENT-DETAILS");

                var obj = {
                    jobRole: {
                        "level": 0,
                        "name": jobRole,
                        "desc": "",
                        "app": "",
                        "entitlements": []
                    }
                };

                var secondObj = {};

                for(var i = 0; i < entitlements.length; i++) {
                    
                    var entitlement = entitlements[i];

                    // Name and ID are useless
                    var name = entitlement.childNodes[1].innerHTML.trim();
                    var id = entitlement.childNodes[3].innerHTML.trim();
                    var hierarchy = entitlement.childNodes[9].innerHTML.trim();

                    // console.log(entitlement.childNodes);
                    var package = [
                        entitlement.childNodes[11].innerHTML.trim(),
                        entitlement.childNodes[13].innerHTML.trim(),
                        entitlement.childNodes[15].innerHTML.trim(),
                        // 15 is duty role desc
                        entitlement.childNodes[17].innerHTML.trim(),
                        entitlement.childNodes[19].innerHTML.trim(),
                        entitlement.childNodes[21].innerHTML.trim(),
                        // 21 is entitlement desc
                        entitlement.childNodes[7].innerHTML.trim() // hopefully the app
                    ];

                    var hierarchyItems = hierarchy.split("-&gt;");

                    var level = hierarchyItems.length;

                    if(obj[hierarchyItems[hierarchyItems.length - 1]] == undefined) {
                        obj[hierarchyItems[hierarchyItems.length - 1]] = {
                            "level": level,
                            "name": package[1],
                            "desc": package[2],
                            "app": package[6]
                        }
                    }

                    if(package[4] != 'NO DATA AVAILABLE') {
                        if(secondObj[hierarchyItems[hierarchyItems.length - 1]] == undefined)
                            secondObj[hierarchyItems[hierarchyItems.length - 1]] = [];
                        
                        secondObj[hierarchyItems[hierarchyItems.length - 1]].push({
                            'name': package[4],
                            'desc': package[5],
                            'dutyName': package[1]
                        });
                    }
                }

                constructCSV(obj, secondObj);
            }

            function constructCSV(obj, secondObj) {
                console.log(secondObj);
                var secondString = "Job Role,Granted Role,Privilege,Privilege Description,Grant?\n\n";
                var o = "Duties\n";
                o += "\n";
                o += "Level, Job Role,Job Role Description,Duty Role,Description,Application\n";
                o += "\n";
                
                for(var key in obj) {
                    var item = obj[key];
                    var first = true;

                    if(item.level == 0) {
                        o += '"' + item.level + '","' + item.name + '"\n';
                    } else {
                        o += '"' + item.level + '",,,"' + item.name + '","' + item.desc + '","' + item.app +'"\n';
                    }
                }

                o +="\n";
                    
                for(var entitlement in secondObj) {
                    var ent = secondObj[entitlement];

                    for(var i = 0; i < ent.length; i++) {
                        if(i == 0) {
                            secondString += ',"' + ent[i].dutyName + '","' + ent[i].name + '","' + ent[i].desc + '",,\n';
                        } else {
                            secondString += ',,"' + ent[i].name + '","' + ent[i].desc + '",,\n';
                        }
                    }
                }

                o += secondString;

                download("output.csv", o);
            }

            function download(filename, text) {
                var pom = document.createElement('a');
                pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                pom.setAttribute('download', filename);

                if (document.createEvent) {
                    var event = document.createEvent('MouseEvents');
                    event.initEvent('click', true, true);
                    pom.dispatchEvent(event);
                }
                else {
                    pom.click();
                }
            }
        </script>
        <style>
            .drag {
                border: 2px solid black;
                width: 90vw;
                margin: 5%;
            }
        </style>
    </head>
    <body>
        <h2>Oracle User and Role Access Audit Report Processor</h2>
        <div class="drag" id="drag">
            <h1 style="text-align: center">Drag file here to upload</h1>
        </div>
        <!--<textarea id="input" rows="10" cols="80">
        </textarea>-->
        <!--<label for="inputfile">Name of file: </label><input id="inputfile" type="text" />
        <br />-->
        <!--<button id="execute" onclick="getFile($('#input').val())">Submit</button>
        <h2>Output</h2>
        <textarea id="output" rows="10" cols="80">
        </textarea>-->
    </body>
</html>